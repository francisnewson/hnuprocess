---
#Study halo using P6
#Autopass
- selection:
    name: passer
    type : auto_pass

###################################################
# FILE MANAGEMENT
###################################################

- output:
    name: os_cerr
    type: ostream
    filename: cerr

- output:
    name: os_stats
    type: ostream
    filename: halo_stats.dat

- output:
    name: tfout
    type: tfile
    filename: halo_plots.root

- output:
    name: tfout
    type: tfile
    filename: halo_plots.root

###################################################
# STANDARD CORRECTIONS
###################################################

#automatically load the correct kind of kaon track
#(including 1 + beta corrections)
- input:
    name: kaon_track
    type: KaonTrack
    kaon_type: auto
    beam_mapping: input/reco/beam/beam_mapping.yaml

#kaon weights
- selection:
    name: kaon_mom_weights
    type: KaonMomWeight
    crude_weights: "input/reco/mod/kaon_crude_weights.dat"
    fine_weights: "input/reco/mod/kaon_fine_weights.dat"

#standard cluster corretions
- input:
    name: cluster_corrector
    type: ClusterCorrector
    filename: "/afs/cern.ch/user/f/fnewson/work/hnu/gopher/data/detector/eopCorrfile.dat"
    enabled: true


###################################################
# DATA SAMPLE DEFINITION
###################################################

# 1]Bad bursts
- selection:
    name: good_phys_burst
    type: BadBurst
    burst_list: "input/reco/conditions/bad_phys_burst.dat"

- selection:
    name: good_dch_burst
    type: BadBurst
    burst_list: "input/reco/conditions/bad_dch_burst.dat"

- selection:
    name: good_muv_burst
    type: BadBurst
    burst_list: "input/reco/conditions/bad_muv_burst.90.dat"

- selection:
    name: weighted_data_sample
    type: CompositeSelection
    children:
        - kaon_mom_weights
        - good_phys_burst
        - good_dch_burst
        - good_muv_burst

- selection:
    name: mcz
    type: MCZCut
    min_z: -1800
    max_z:  8000

- selection:
    name: weighted_mc_sample
    type: CompositeSelection
    children:
        - weighted_data_sample
        - mcz

- analysis:
    name: sample_burst_count
    type: BurstCount
    tfile: tfout
    folder: sample_burst_count
    selection: weighted_mc_sample
    codename: bursts

###################################################
# INPUTS
###################################################

#----------Single Track
- input: { name : bf_st, type : SingleTrack,  method : BF,
    init_min_mom: 3.0 , init_max_mom: 80,
    init_max_cda: 15.0, init_min_z: -5000.0, init_max_z:  10000.0,
    dch_merge_sep: 0.5,
    inputs: { kt: kaon_track } }

#----------km2 event
- input: { name: km2_event, type: Km2Event,
    inputs: { ogt: bf_st, kt: kaon_track } }

#---------km2 clusters
- input: { name: km2_clusters, type: Km2Clusters,
    noise_energy: 3, noise_time: 12, brehm_radius: 0 ,
    track_cluster_radius: 5, extra_lkr_check: false,
    inputs: { ogt: bf_st, ClusterCorrector: cluster_corrector } }

- input:
    name: single_muon
    type: SingleMuon
    method: auto
    multiplier: 4
    inputs:
        ogt: bf_st

- selection:
    name: muon_xy_wgt
    type: MuonTHXYWeight
    effs_file: input/reco/conditions/muv_xy.root
    effs_hist: rat_xy
    inputs:
        ogt: bf_st

- selection:
    name: muon_p_wgt
    type: MuonTHPWeight
    effs_file: input/reco/conditions/muv/muv_eff_p.root
    effs_hist: rat_p
    inputs:
        ogt: bf_st


###################################################
# CUTS
###################################################

#-------- 2.] Found ogt ( DCH VETO )
- selection: {name: good_trk, type : FoundGoodTrack,
  inputs : {ogt: bf_st} }

#-------- 3.] Track charge
- selection: { name: pos_trk, type : TrackCharge,
    charge: +1, inputs : {ogt: bf_st} }

#------- 4.] Track quality
- selection: { name: quality_7, type: TrackQuality,
    quality: 0.7, inputs: { ogt: bf_st} }

#-------- 9.] LKr acceptance
- selection: {name: rk_lkr_accep, type: TrackLkrAcceptance,
    margin_parameter: 8, inputs: { ogt: bf_st } }

#--------10.] Hot Cells
- selection: {name: rk_hot_lkr, type: Km2HotLkr,
    hot_cells: [ [ 134, 56 ], [ 134, 57 ] ],
    inputs: { km2event: km2_event, km2clusters: km2_clusters } }

#------- 6.] NoBadClusters ( LKr VETO )
- selection: {name: rk_lkr_veto, type: Km2NoBadCluster,
    inputs: {km2clusters: km2_clusters} }

#-------- 7.] PZ (FIDUCIAL VOLUME)
- selection: {name: fiducial_pz, type: TrackPZ,
    shape: rectangles, points: [ [  3, 70, -3000, 9000 ] ],
    inputs: {ogt: bf_st} }

#--------13.] Track DHC1 ACC
- selection: { name: dch1_acc, type: TrackRadialAcceptance,
    track_section: upstream, z: 9708.42,
    inner: 12.0, outer: 115.0,
    inputs: { ogt: bf_st} }

#--------14.] Track DHC4 ACC
- selection: { name: dch4_acc, type: TrackRadialAcceptance,
    track_section: downstream, z: 11888.0,
    inner: 14.0, outer: 115.0,
    inputs: { ogt: bf_st} }

#--------16.] Track time
- selection: { name: rk_dcht, type : TrackTime,
    max_dt: 20,  inputs: { ogt: bf_st } } 

#--------Dead Cells
- selection: { name: ddead_cell, type: TrackDDeadCell, 
    min_ddead_cell: 2.0,  inputs: {ogt: bf_st } }

- selection: { 
    name: rk_cda, type: TrackCda,
    min_cda: 0.0, max_cda: 3.5,
    inputs: { ogt: bf_st } }

- selection: { 
    name: my_cda, type: TrackCda,
    min_cda: 0.0, max_cda: 3.0,
    inputs: { ogt: bf_st } }

- selection:
   { name: muon_req_38, type: MuonReq, multiplier: 3.8, inputs: {ogt: bf_st, sm: single_muon } }

- selection:
    { name: muon_req, type: CompositeSelection, children: [muon_req_38, muon_xy_wgt, muon_p_wgt] }

###################################################
# ZT REGIONS
###################################################

- selection:
    name: zt_dn
    type: TrackZT
    track_section: us
    shape: polygon
    points:
        - [ -3000,  0.000 ] 
        - [ -3000,  0.012 ] 
        - [  -800,  0.012 ] 
        - [  1600,  0.005 ] 
        - [  6000,  0.001 ] 
        - [  6000,  0.000 ] 
        - [ -3000,  0.000 ] 
    inputs: { km2event: km2_event } 

- selection:
    name: zt_up
    type: TrackZT
    track_section: us
    shape: polygon
    points:
        - [ 10000,  0.001 ] 
        - [  6000,  0.001 ] 
        - [  1600,  0.005 ] 
        - [  -800,  0.012 ] 
        - [  -800,  0.025 ] 
        - [ 10000,  0.025 ] 
        - [ 10000,  0.001 ] 
    inputs: { km2event: km2_event } 

###################################################
# UP
###################################################

- selection:
    name: zphi_up
    type: TrackTPhi
    shape: polygon
    points:
        - [0.000 , 0.00 ]
        - [0.020 , 0.00 ]
        - [0.020 , 0.73 ]
        - [0.012 , 0.90 ]
        - [0.009 , 1.51 ]
        - [0.006 , 2.30 ]
        - [0.005 , 2.60 ]
        - [0.004 , 3.20 ]
        - [0.004 , 3.40 ]
        - [0.005 , 4.00 ]
        - [0.006 , 4.30 ]
        - [0.009 , 4.77 ]
        - [0.012 , 5.38 ]
        - [0.020 , 5.55 ]
        - [0.020 , 6.40 ]
        - [0.000 , 6.40 ]
        - [0.000 , 0.00 ]
    inputs: { km2event: km2_event } 

###################################################
# DN
###################################################

- selection:
    name: zphi_dn_tgt
    type: TrackZT
    shape: polygon
    points:
        - [  -450 ,  0.0200 ] 
        - [  -450 ,  0.0110 ] 
        - [  -325 ,  0.0085 ] 
        - [   175 ,  0.0060 ] 
        - [  1000 ,  0.0040 ] 
        - [  2000 ,  0.0030 ] 
        - [  3075 ,  0.0025 ] 
        - [  3400 ,  0.0016 ] 
        - [  3500 ,  0.0000 ] 
        - [ 10000 ,  0.0000 ] 
        - [ 10000 ,  0.0200 ] 
        - [  -450 ,  0.0200 ] 
    inputs: { km2event: km2_event } 

- selection:
    name: zphi_dn_med
    type: TrackZT
    shape: polygon
    points:
        - [  -700 ,  0.0200 ] 
        - [  -700 ,  0.0110 ] 
        - [  -575 ,  0.0085 ] 
        - [   -75 ,  0.0060 ] 
        - [   750 ,  0.0040 ] 
        - [  1770 ,  0.0030 ] 
        - [  2825 ,  0.0025 ] 
        - [  3150 ,  0.0016 ] 
        - [  3250 ,  0.0000 ] 
        - [ 10000 ,  0.0000 ] 
        - [ 10000 ,  0.0200 ] 
        - [  -700 ,  0.0200 ] 
    inputs: { km2event: km2_event } 

- selection:
    name: zphi_dn_loose
    type: TrackZT
    shape: polygon
    points:
        - [  -950 ,  0.0200 ] 
        - [  -950 ,  0.0110 ] 
        - [  -825 ,  0.0085 ] 
        - [  -325 ,  0.0060 ] 
        - [   500 ,  0.0040 ] 
        - [  1500 ,  0.0030 ] 
        - [  2575 ,  0.0025 ] 
        - [  2900 ,  0.0016 ] 
        - [  3000 ,  0.0000 ] 
        - [ 10000 ,  0.0000 ] 
        - [ 10000 ,  0.0200 ] 
        - [  -950 ,  0.0200 ] 
    inputs: { km2event: km2_event } 

- selection:
    name: pt_dn
    type: TrackPT
    shape: polygon
    points:
        - [  0, 0.000 ]
        - [  0, 0.015 ]
        - [ 12, 0.000 ]
        - [ 100, 0.000 ] 
        - [ 100, 0.500 ] 
        - [ 0, 0.500 ] 
    inputs: { km2event: km2_event } 

###################################################
# Mass
###################################################

- selection: {
    name: m2_high, type: Km2M2Miss,
    min_m2: 0.09, max_m2: 0.13,
    inputs: { km2event: km2_event } }


###################################################
# SELECTIONS
###################################################

- selection:
    name: pre_selection
    type: CompositeSelection
    children:
        - weighted_data_sample
        - good_trk
        - pos_trk
        - quality_7
        - fiducial_pz
        - dch1_acc
        - dch4_acc
        - rk_lkr_accep
        - rk_hot_lkr
        - rk_lkr_veto
        - rk_dcht
        - ddead_cell

- selection: { name: pre_up, type: CompositeSelection, children: [ pre_selection, zt_up ] }
- selection: { name: pre_dn, type: CompositeSelection, children: [ pre_selection, zt_dn ] }

- selection: { name: high_up, type: CompositeSelection, children: [ pre_up, m2_high ] }
- selection: { name: high_dn, type: CompositeSelection, children: [ pre_dn, m2_high ] }

- selection: { name: full_up, type: CompositeSelection, children: [ pre_up, my_cda, zphi_up ] }
- selection: { name: full_dn_tgt, type: CompositeSelection, children: [ pre_dn, my_cda, pt_dn, zphi_dn_tgt,  ] }
- selection: { name: full_dn_med, type: CompositeSelection, children: [ pre_dn, my_cda, pt_dn, zphi_dn_med,  ] }
- selection: { name: full_dn_loose, type: CompositeSelection, children: [ pre_dn, my_cda, pt_dn, zphi_dn_loose,  ] }

##################################################
#
# ANALYSES
#
##################################################

- analysis : { type: Km2Plotter, name: pre_plots, folder: pre_plots,
    tfile: tfout, selection: pre_selection, inputs: { km2event: km2_event } }


- analysis : { type: Km2Plotter, name: pre_up_plots, folder: pre_up_plots,
    tfile: tfout, selection: pre_up, inputs: { km2event: km2_event } }

- analysis : { type: Km2Plotter, name: pre_dn_plots, folder: pre_dn_plots,
    tfile: tfout, selection: pre_dn, inputs: { km2event: km2_event } }


- analysis : { type: Km2Plotter, name: high_up_plots, folder: high_up_plots,
    tfile: tfout, selection: high_up, inputs: { km2event: km2_event } }

- analysis : { type: Km2Plotter, name: high_dn_plots, folder: high_dn_plots,
    tfile: tfout, selection: high_dn, inputs: { km2event: km2_event } }


- analysis : { type: Km2Plotter, name: full_up_plots, folder: full_up_plots,
    tfile: tfout, selection: full_up, inputs: { km2event: km2_event } }

- analysis : { type: Km2Plotter, name: full_dn_tgt_plots, folder: full_dn_tgt_plots,
    tfile: tfout, selection: full_dn_tgt, inputs: { km2event: km2_event } }

- analysis : { type: Km2Plotter, name: full_dn_med_plots, folder: full_dn_med_plots,
    tfile: tfout, selection: full_dn_med, inputs: { km2event: km2_event } }

- analysis : { type: Km2Plotter, name: full_dn_loose_plots, folder: full_dn_loose_plots,
    tfile: tfout, selection: full_dn_loose, inputs: { km2event: km2_event } }


- analysis : {name : full_summary, type: Summary, 
    base : passer, source : pre_selection, ostream: os_stats } 

- analysis : 
    name : rk_like_summary
    type: Summary
    base : passer
    source : pre_selection 
    ostream: os_stats

