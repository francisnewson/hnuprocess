#Full km2 selection with explanatory plots

#-------------------------------------------------- 

###################################################
# FILE MANAGEMENT
###################################################

- output:
    name: tfout
    type: tfile
    filename: km2_plots.root

###################################################
# STANDARD CORRECTIONS
###################################################

- input:
    name: kaon_track
    type: KaonTrack
    kaon_type: auto
    beam_mapping: input/reco/beam/beam_mapping.yaml

- selection:
    name: kaon_mom_weights
    kt: kaon
    type: KaonMomWeight
    crude_weights: input/reco/mod/kaon_crude_weights.dat
    fine_weights: input/reco/mod/kaon_fine_weights.dat

- input:
    name: cluster_corrector
    type: ClusterCorrector
    filename: "/afs/cern.ch/user/f/fnewson/work/hnu/gopher/data/detector/eopCorrfile.dat"
    enabled: true

- output:
    name: text_out
    type: ostream
    filename: cerr

- output:
    name: stats_out
    type: ostream
    filename: km2_stats.dat

- output:
    name: debug_out
    type: ostream
    filename: km2_debug.dat

# 1]Bad bursts
- selection:
    name: good_phys_burst
    type: BadBurst
    burst_list: "input/reco/conditions/bad_phys_burst.dat"

- selection:
    name: good_dch_burst
    type: BadBurst
    burst_list: "input/reco/conditions/bad_dch_burst.dat"

- selection:
    name: good_muv_burst
    type: BadBurst
    burst_list: "input/reco/conditions/bad_muv_burst.90.dat"

- selection:
    name: good_muv_burst_range
    type: BadBurstRange
    burst_range_list: "input/reco/conditions/bad_muv_burst_ranges.dat"

- selection:
    name: weighted_data_sample
    type: CompositeSelection
    children:
        - kaon_mom_weights
        - good_phys_burst
        - good_dch_burst
        - good_muv_burst
        - good_muv_burst_range

- selection:
    name: mcz
    type: MCZCut
    min_z: -1800
    max_z:  8000

- selection:
    name: weighted_mc_sample
    type: CompositeSelection
    children:
        - weighted_data_sample
        - mcz

- analysis:
    name: sample_burst_count
    type: BurstCount
    tfile: tfout
    folder: sample_burst_count
    selection: weighted_mc_sample
    codename: bursts

###################################################
# INPUTS
###################################################

#SingleTrack
- input:
    name : bf_st
    type : SingleTrack
    method : BF

    init_min_mom: 3.0 
    init_max_mom: 75.0

    init_max_cda: 15.0

    init_min_z: -2000.0
    init_max_z:  9000.0

    dch_merge_sep: 0.5

    inputs:
        kt: kaon_track

- input:
    name: km2_event
    type: Km2Event
    inputs:
        ogt: bf_st
        kt: kaon_track

#Km2Clusters
- input:
    name: full_km2clusters
    type: Km2Clusters
    noise_energy: 5 #GeV
    noise_time: 12 #ns
    brehm_radius: 0 #cm
    track_cluster_radius: 40 #cm
    inputs:
        ogt: bf_st
        ClusterCorrector: cluster_corrector

- input:
    name: single_muon
    type: SingleMuon
    multiplier: 4
    method: auto
    inputs:
        ogt: bf_st

- selection:
    name: req_muon
    type: MuonReq
    multiplier: 3.8
    inputs:
        sm: single_muon
        ogt: bf_st

- selection:
    name: muon_xy_wgt
    type: MuonTHXYWeight
    effs_file: input/reco/conditions/muv_xy.root
    effs_hist: rat_xy
    inputs:
        ogt: bf_st

- selection:
    name: muon_p_wgt
    type: MuonTHPWeight
    effs_file: input/reco/conditions/muv_p.root
    effs_hist: rat_p
    inputs:
        ogt: bf_st

- selection:
    name: muon_veto
    type: CompositeSelection
    children:
        - req_muon
        - muon_p_wgt
        - muon_xy_wgt

#Autopass
- selection:
    name: passer
    type : auto_pass

###################################################
# CUTS
###################################################

#Found ogt
- selection:
    name: good_trk
    type : FoundGoodTrack
    inputs :
        ogt: bf_st

#Track charge
- selection:
    name: pos_trk
    type : TrackCharge
    charge: +1
    inputs :
        ogt: bf_st

#Track quality
- selection:
    name: quality_7
    type: TrackQuality
    quality: 0.7
    inputs:
        ogt: bf_st

- selection:
    name: cda_3cm
    type: TrackCda
    max_cda: 3.0 #cm
    inputs:
        ogt: bf_st

#Track DHC1 ACC
- selection:
    name: dch1_acc
    type: TrackRadialAcceptance
    track_section: upstream
    z: 9708.42 #zDCH1
    inner: 12.0
    outer: 115.0
    inputs:
        ogt: bf_st

#Track DHC4 ACC
- selection:
    name: dch4_acc
    type: TrackRadialAcceptance
    track_section: downstream
    z: 11888.0 #zDCH1
    inner: 14.0
    outer: 115.0
    inputs:
        ogt: bf_st

# 9] LKr acceptance
- selection:
    name: rk_lkr_accep
    type: TrackLkrAcceptance
    margin_parameter: 8 #cm
    inputs:
        ogt: bf_st

- selection:
    name: rk_hot_lkr
    type: Km2HotLkr
    hot_cells: [ [ 134, 56 ], [ 134, 57 ] ]
    inputs:
        km2event: km2_event
        km2clusters: full_km2clusters

#Track time
- selection:
    name: rk_dcht
    type : TrackTime
    max_dt: 20 #ns
    inputs:
        ogt: bf_st

#NoBadClusters
- selection:
    name: rk_lkr_veto
    type: Km2NoBadCluster
    inputs:
        km2clusters: full_km2clusters

- selection:
    name: muv_acc
    type: TrackXYUVAcceptance
    track_section: ds
    z: 13012.0 #MUV3
    min_x: -135.0
    max_x:  135.0
    min_y: -135.0
    max_y:  135.0
    min_u: -135.0
    max_u:  135.0
    min_v: -135.0
    max_v:  135.0
    inputs:
        ogt: bf_st

- selection:
    name: zt_cut
    type: TrackZT
    track_section: us
    shape: polygon
    points:
        - [  -935,   0.0097 ]
        - [  -495, 0.0080]
        - [  -170,  0.0062]
        - [   230,    0.0050]
        - [   855,   0.0040]
        - [  1565,   0.0030]
        - [  2044,   0.0028]
        - [  2400,  0.0014]
        - [  2225,  0 ]
        - [  2185,  0 ]
        - [  10000, 0 ]
        - [  10000, 0.1 ]
        - [   -935, 0.1 ]
        - [   -935, 0.0097 ]
    inputs:
        km2event: km2_event

- selection:
    name: tphi_cut
    type: TrackTPhi
    track_section: us
    shape: polygon
    points:
        - [ 0.0094 , -0.00 ]
        - [ 0.0102 , 0.5843015 ]
        - [ 0.0102 , 1.2571541 ]
        - [ 0.0085 , 1.9605523 ]
        - [ 0.0072 , 2.4188466 ]
        - [ 0.0065 , 3.0041392 ]
        - [ 0.00634,     3.6530917 ] 
        - [ 0.0071 , 4.1602197 ]
        - [ 0.0080 , 4.390358 ]
        - [ 0.0096 , 4.5971403 ]
        - [ 0.0102 , 5.0329027 ]
        - [ 0.0102 , 5.499908 ]
        - [ 0.0088 , 6.08481 ]
        - [ 0.0085 , 6.322096 ]
        - [ 0.0000 , 6.322096 ]
        - [ 0.0000 , 0 ]
    inputs: 
        km2event: km2_event



- analysis:
    name: full_km2_breakdown
    type: Km2Breakdown
    base: weighted_data_sample
    selection:
    -  {  cut:  good_trk,      plot:  []              }
    -  {  cut:  pos_trk,       plot:  [ m2m             ]   }
    -  {  cut:  zt_cut,        plot:  [ zt,             m2m ]  }
    -  {  cut:  tphi_cut,      plot:  [ tphi,           m2m ]  }
    -  {  cut:  quality_7,     plot:  [ track_quality,  m2m ]  }
    -  {  cut:  cda_3cm,       plot:  [ cda,            m2m ]  }
    -  {  cut:  dch1_acc,      plot:  [ rdch1,          m2m ]  }
    -  {  cut:  dch4_acc,      plot:  [ rdch4,          m2m ]  }
    -  {  cut:  rk_lkr_accep,  plot:  [ xylkr,          m2m ]  }
    -  {  cut:  rk_hot_lkr,    plot:  [ rdch4,          m2m ]  }
    -  {  cut:  rk_lkr_veto,   plot:  [ rcluster,       m2m ]  }
    -  {  cut:  rk_dcht,       plot:  [dcht,            m2m ]  }

    good_track: good_trk
    tfile: tfout
    folder: km2_breakdown
    inputs:
        km2event: km2_event
        km2clusters: full_km2clusters
